# 模組 3：Flows 與動態規劃

***

### **講座：第 5-6 週**

**授課者：** Dr. Cortex

**主題：** 事件驅動架構：透過 CrewAI Flows 實現動態工作流程

***

#### **1. 第一原理：從靜態計劃到事件驅動反應**

我們之前探討的層級式流程，其規劃是在*啟動時*生成的。然而，真實世界的系統必須能應對*執行中*發生的不可預測事件。

這裡的**第一原理**是**事件響應 (Event Response)**。一個真正自主的系統，不僅要能制定計劃，更必須能夠感知其環境或自身狀態的變化（即「事件」），並根據這些事件動態地調整其行為。一個無法對事件做出反應的系統，其本質上是脆弱的、非自適應的。

---

#### **2. 基礎知識：CrewAI Flows**

`CrewAI Flows` 提供了一個強大的事件驅動編程模型，讓我們能夠超越固定的 `sequential` 或 `hierarchical` 流程，設計出能夠根據實時條件進行分支、循環和重新路由的複雜工作流程。

##### **核心組件：裝飾器 (Decorators)**

Flows 的核心是 Python 裝飾器，它們將普通函數轉換為工作流程中的反應式節點。

-   **`@start`**: 標記工作流程的唯一入口點。
-   **`@listen`**: 將一個函數註冊為特定事件的監聽器。當該事件被觸發時，此函數將被異步調用。
-   **`@router`**: 這是一個條件分支的決策點。它評估當前狀態，並決定接下來應該觸發哪個事件，從而將控制權「路由」到工作流程的另一部分。
-   **`@persist`**: 確保一個函數的輸出（或狀態變更）被持久化，以便在工作流程的其他部分可以被存取。

##### **狀態管理 (State Management)**

Flows 引入了一個明確的**狀態 (State)** 概念。狀態是儲存工作流程當前所有資訊的容器，可以是 Pydantic 模型（結構化）或字典（非結構化）。工作流程中的每個節點都可以讀取和修改這個共享狀態，而 `@router` 正是根據狀態的值來做出決策。

---

#### **3. 知識體系（BoK）：動態規劃調整 (Dynamic Plan Adaptation)**

**定義：** 動態規劃調整是規劃模式的延伸。它不僅僅是在開始時制定計劃，更是在執行過程中，根據新的資訊或事件，持續地**重新評估**和**修改**該計劃。

在 `CrewAI Flows` 中，`@router` 是實現動態規劃調整的關鍵。

##### **範例場景：AQI（空氣品質指數）警示 Flow**

設想一個監控空氣品質並在需要時發送警報的系統。一個靜態的計劃可能如下：
1.  查詢 AQI
2.  發送警報
3.  結束

但一個動態的、事件驅動的 Flow 會是這樣：

1.  **`@start`**: 觸發 `CHECK_AQI` 事件。
2.  **`@listen(CHECK_AQI)`**: 一個函數執行，調用一個工具（如 API）來獲取當前 AQI 數值，並將其儲存到**狀態**中。完成後，觸發 `EVALUATE_AQI` 事件。
3.  **`@router(EVALUATE_AQI)`**: 路由器函數被觸發。它讀取狀態中的 AQI 值：
    *   **如果 AQI > 150 (不健康)**：觸發 `SEND_ALERT` 事件。
    *   **如果 50 < AQI <= 150 (中等)**：觸發 `RETRY_LATER` 事件。
    *   **如果 AQI <= 50 (良好)**：觸發 `END_FLOW` 事件。
4.  **`@listen(SEND_ALERT)`**: 執行發送警報的邏輯。
5.  **`@listen(RETRY_LATER)`**: 執行等待一段時間後，重新觸發 `CHECK_AQI` 的邏輯。

在這個模型中，工作流程不再是一條直線。它是一個根據外部數據（AQI 值）動態導航的狀態機。這就是動態規劃調整的精髓。

---

#### **4. 實驗室指引：實驗 3**

請參閱 `lab/lab_3.md`。您的任務是設計並實現這個「AQI 警示 Flow」。

您需要：
1.  定義一個包含 AQI 數值的狀態。
2.  創建一個模擬查詢 AQI 的工具。
3.  使用 `@start`、`@listen` 和 `@router` 裝飾器來構建整個事件驅動的工作流程。
4.  測試不同的 AQI 值，並驗證您的 Flow 是否能正確地將任務路由到「發送警報」、「稍後重試」或「結束」的分支。

本實驗將使您從思考「任務序列」轉變為思考「狀態與事件」，這是構建複雜、真實世界 AI 系統的關鍵心態轉變。

講座結束。


