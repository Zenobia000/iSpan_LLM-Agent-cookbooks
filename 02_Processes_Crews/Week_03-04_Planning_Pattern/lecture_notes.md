# 模組 2：Crew 流程與規劃模式

***

### **講座：第 3-4 週**

**授課者：** Dr. Cortex

**主題：** 協調複雜性：層級式流程與規劃模式

***

#### **1. 第一原理：從線性執行到管理委派**

我們已經確定，工作是由一個 `Agent` 執行一個 `Task` 來完成的。最簡單的協調方式是線性序列。然而，複雜的問題很少是線性的，它們要求更高層次的組織。

這裡的**第一原理**是**任務分解（Task Decomposition）**。任何複雜的目標都可以被分解為一系列更小、更易於管理的子任務。一個無法執行這種分解的系統，在根本上僅限於簡單的、順序性的工作流程。

第二個原理是**智能委派（Intelligent Delegation）**。一旦任務被分解，就必須將它們指派給最合適的代理。這需要一個管理實體，它既要理解任務需求，也要了解可用代理的能力。

---

#### **2. 基礎知識：CrewAI 流程**

CrewAI 透過其 `Process` 模型來實踐這些原理。

##### **2.1 `Process.sequential`（順序流程）**

-   **機制**：任務按照嚴格的、預定的順序執行。任務 N 的輸出會自動成為任務 N+1 的上下文。
-   **類比**：一條裝配線。
-   **限制**：不靈活。它無法適應意外的結果或動態地重新安排其工作流程。它不適用於需要戰略性監督的複雜問題。

##### **2.2 `Process.hierarchical`（層級流程）**

-   **機制**：此流程引入了一個新的、關鍵的組件：**管理者代理（Manager Agent）**。它作為一個主控制器運作。
-   **核心功能**：
    1.  **分解**：管理者代理分析總體目標，並將其分解為一個連貫的子任務序列。這就是**規劃模式（Planning Pattern）**的實際應用。
    2.  **委派**：它智能地將每個子任務分配給 crew 中最合適的代理。
    3.  **品質控制**：它審查每個工作代理的輸出，以確保其在繼續進行前符合要求的標準。
-   **要求**：您*必須*為 `Crew` 定義一個 `manager_llm` 或一個完整的 `manager_agent`。這是協調整個流程的智能核心。

---

#### **3. 知識體系（BoK）：規劃模式（The Planning Pattern）**

**定義：** 規劃模式涉及在執行開始*之前*，為達成一個複雜目標而創建一個結構化的、多步驟的計劃。這個計劃，通常以工作分解結構（Work-Breakdown Structure, WBS）的形式呈現，作為 crew 的路線圖。

在 CrewAI 的層級流程中，管理者代理是規劃模式的化身。它不僅僅是執行；它進行*策略規劃*。

##### **3.1 `manager_agent.plan()` 方法**

一個強大的可視化方法，是將其概念化為管理者上的一個 `.plan()` 方法。當您給它一個高層次的目標，如「撰寫一份關於電動車行業的市場分析報告」，管理者的第一步就是制定一個計劃。

**概念性實現：**

```python
# 這是一個概念性的表示
plan = manager_agent.plan("撰寫一份關於電動車行業的市場分析報告。")

# 輸出將會是一個結構化的子任務列表：
# ["收集近期的市場數據與新聞文章。",
#  "分析競爭對手策略（特斯拉、比亞迪等）。",
#  "總結主要市場趨勢與未來預測。",
#  "整合所有發現，起草最終報告。"]
```

然後，層級流程會執行這個生成的計劃，將每個步驟委派給最適合的代理（例如，一個 `ResearcherAgent` 負責數據收集，一個 `WriterAgent` 負責起草）。

---

#### **4. 實驗室指引：實驗 2**

請參閱 `lab/lab_2.md`。您將建構一個由 `Planner`（管理者）、`Researcher` 和 `Writer` 組成的層級式 crew。

您的主要目標不僅僅是產出報告，而是要：
1.  在詳細輸出中，分析管理者代理的初始規劃階段。
2.  追蹤它如何將任務委派給專家代理。
3.  作為一項交付成果，您將手動創建一個甘特圖，以視覺化地呈現由管理者協調的任務依賴關係和執行流程。這將證明您對所生成計劃的理解。

本實驗將鞏固您對如何在先進的多代理系統中解構和管理複雜專案的理解。

講座結束。
